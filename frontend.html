<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepolia Contract Frontend - Private Key Signer</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button, input { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .section { margin-bottom: 20px; padding: 10px; border: 1px dashed #eee; }
        #status { font-weight: bold; color: blue; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Payment Contract Interaction (Private Key)</h1>
        <p id="status">Initializing...</p>
        <p><strong>Contract Address:</strong> <code id="contractAddressDisplay"></code></p>
        <hr>

        <div class="section">
            <h2>Current Balance (Read)</h2>
            <p>Contract Balance: <strong id="currentBalance">Loading...</strong></p>
            <button onclick="readBalance()">Refresh Balance</button>
        </div>

        <div class="section">
            <h2>Send Payment (Write)</h2>
            <input type="number" id="paymentAmount" value="0.001" min="0" step="0.0001">
            <label for="paymentAmount">ETH</label>
            <button onclick="sendPayment()">Send Payment</button>
        </div>

        <div class="section">
            <h2>Withdraw Funds (Owner Only)</h2>
            <button onclick="withdrawFunds()">Withdraw All</button>
            <p><em>(This transaction will be signed automatically by your private key.)</em></p>
        </div>

        <div id="logs">
            <h3>Logs:</h3>
        </div>
    </div>
    
    <script>
        // --- 1. CONFIGURATION (CORRECTED & CONFIRMED) ---
        const CONTRACT_ADDRESS = "0x5a24bAA368Db89d7aB4313f84AC63a8b4b422813"; // Your Contract Address
        const SEPOLIA_RPC_URL = "https://ethereum-sepolia-rpc.publicnode.com"; // Confirmed Stable Public Endpoint
        
        // Private key for 0x45ef42ee7e7e3cebe682934cc467f7d4e8ad7f36
        const PRIVATE_KEY = "0x20b2efb52d2a3e9975c485c40062c9ea15682023a70e595f851cfb2923cabdf5"; 

        // The ABI (The structure of the contract functions)
        const CONTRACT_ABI = [
             { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
             { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "Payment", "type": "event" },
             { "inputs": [], "name": "getBalance", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
             { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" },
             { "inputs": [], "name": "pay", "outputs": [], "stateMutability": "payable", "type": "function" },
             { "inputs": [], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        // Global variables for ethers
        let provider;
        let signer;
        let contract;

        document.getElementById('contractAddressDisplay').textContent = CONTRACT_ADDRESS;

        // --- 2. CONNECT TO THE BLOCKCHAIN (Programmatic Connection) ---
        async function connectWallet() {
            try {
                // 1. Create a Provider using the Sepolia RPC URL
                provider = new ethers.providers.JsonRpcProvider(SEPOLIA_RPC_URL);

                // 2. Create a Signer (Wallet) using the private key and the provider
                signer = new ethers.Wallet(PRIVATE_KEY, provider); 
                
                // 3. Initialize the Contract object with the self-signing Wallet
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                const userAddress = await signer.getAddress();
                document.getElementById('status').textContent = `Connected (Private Key). Account: ${userAddress}`;
                document.getElementById('status').classList.remove('error');
                
                readBalance(); // Initial balance read

            } catch (error) {
                console.error("Connection error:", error);
                document.getElementById('status').textContent = "Error: Failed to connect to RPC or initialize wallet.";
                document.getElementById('status').classList.add('error');
            }
        }

        // --- 3. DEFINE FUNCTIONS ---
        
        function logMessage(message, isError = false) {
            const logsDiv = document.getElementById('logs');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                p.classList.add('error');
            }
            logsDiv.prepend(p);
        }

        async function readBalance() {
            if (!contract) return logMessage("Wallet not connected.", true); 
            logMessage("Reading contract balance...");
            const balanceDisplay = document.getElementById('currentBalance');
            
            try {
                const balanceWei = await contract.getBalance();
                const balanceEth = ethers.utils.formatEther(balanceWei);
                
                balanceDisplay.textContent = `${balanceEth} ETH`;
                logMessage(`Success! Contract balance: ${balanceEth} ETH`);
            } catch (error) {
                console.error(error);
                balanceDisplay.textContent = "Error reading balance.";
                logMessage("Error reading balance. See console for details.", true);
            }
        }

        async function sendPayment() {
            if (!contract) return logMessage("Wallet not connected.", true);

            const amountEth = document.getElementById('paymentAmount').value;
            if (!amountEth || isNaN(amountEth) || parseFloat(amountEth) <= 0) {
                return logMessage("Please enter a valid amount.", true);
            }

            logMessage(`Attempting to send ${amountEth} ETH... (Transaction signed automatically)`);

            try {
                const amountWei = ethers.utils.parseEther(amountEth);
                
                // Call the 'pay' function
                const tx = await contract.pay({ value: amountWei });
                
                logMessage(`Transaction sent. Hash: ${tx.hash}`);
                logMessage("Waiting for transaction to be confirmed...");
                
                const receipt = await tx.wait(); // Wait for confirmation

                logMessage(`Success! Payment complete. Block: ${receipt.blockNumber}`);
                readBalance(); // Update display
            } catch (error) {
                console.error(error);
                logMessage("Error sending payment. (Transaction failed or insufficient SepoliaETH)", true);
            }
        }

        async function withdrawFunds() {
            if (!contract) return logMessage("Wallet not connected.", true);

            logMessage("Attempting to withdraw funds... (Transaction signed automatically)");
            
            try {
                // Call the 'withdraw' function
                const tx = await contract.withdraw();
                
                logMessage(`Withdrawal transaction sent. Hash: ${tx.hash}`);
                logMessage("Waiting for transaction to be confirmed...");
                
                const receipt = await tx.wait();

                logMessage(`Success! Withdrawal complete. Block: ${receipt.blockNumber}`);
                readBalance(); // Update display
            } catch (error) {
                console.error(error);
                logMessage("Error withdrawing funds. (Are you the contract owner? Check gas fees.)", true);
            }
        }

        // --- 4. INITIALIZATION ---
        connectWallet();
    </script>
</body>
</html>